<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Tickets for <%= event.title %> | Eventify</title>
    <link rel="stylesheet" href="/home.css">
    <link rel="stylesheet" href="/booking.css">
</head>
<body>

    <%- include('partials/header') %>

    <main class="booking-page-main">
        <div class="booking-container">
            <h1>Confirm Your Booking</h1>
            
            <div class="booking-summary">
                <div class="summary-image">
                    <img src="<%= event.image %>" alt="<%= event.title %>">
                </div>
                <div class="summary-details">
                    <h2><%= event.title %></h2>
                    <p><%= event.date %></p>
                    <p>Single Ticket Price: <strong>‚Çπ<span id="base-price"><%= event.price %></span></strong></p>
                </div>
            </div>

            <form class="booking-form" action="/booking/proceed-to-payment" method="POST">
                <input type="hidden" name="eventId" value="<%= event._id %>">
                <input type="hidden" name="couponApplied" id="coupon-applied" value="false">
                
                <div class="user-details-inputs">
                    <h3>Enter Your Details:</h3>
                    <div class="form-group">
                        <label for="customer-name">Full Name</label>
                        <input type="text" id="customer-name" name="customerName" value="<%= user.name %>" required>
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">Phone Number</label>
                        <input type="tel" id="customer-phone" name="customerPhone" placeholder="Enter your 10-digit phone number" required pattern="[0-9]{10}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ticket-quantity">Number of Tickets</label>
                    <input type="number" id="ticket-quantity" name="quantity" value="1" min="1" max="10" required>
                </div>
                
                <div class="coupon-section">
                    <h3>Have a Coupon Code?</h3>
                    <div class="coupon-input-group">
                        <input type="text" id="coupon-code" name="couponCode" placeholder="Enter coupon code (e.g., EVENTFREE)" maxlength="20">
                        <button type="button" id="apply-coupon-btn" class="btn btn-primary">Apply Coupon</button>
                    </div>
                    <p id="coupon-message"></p>
                </div>

                <div class="price-details">
                    <div class="price-breakdown">
                        <p>Base Price: ‚Çπ<span id="base-price-display"><%= event.price %></span></p>
                        <p>Quantity: <span id="quantity-display">1</span></p>
                        <p id="discount-line" style="display: none;">Discount: -‚Çπ<span id="discount-amount">0</span></p>
                        <p class="total-amount">Total Amount: <span id="total-price">‚Çπ<%= event.price %></span></p>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-confirm-booking">Confirm & Proceed to Pay</button>
            </form>
        </div>
    </main>

    <%- include('partials/footer') %>

    <script>
        const ticketQuantityInput = document.getElementById('ticket-quantity');
        const totalPriceElement = document.getElementById('total-price');
        const basePriceDisplay = document.getElementById('base-price-display');
        const quantityDisplay = document.getElementById('quantity-display');
        const discountLine = document.getElementById('discount-line');
        const discountAmount = document.getElementById('discount-amount');
        const basePrice = parseFloat(document.getElementById('base-price').textContent);
        const couponInput = document.getElementById('coupon-code');
        const applyCouponBtn = document.getElementById('apply-coupon-btn');
        const couponMessage = document.getElementById('coupon-message');
        const couponAppliedInput = document.getElementById('coupon-applied');
        let isCouponApplied = false;
        let originalTotal = basePrice;

        function calculateTotal() {
            const quantity = parseInt(ticketQuantityInput.value, 10) || 0;
            let total = basePrice * quantity;
            originalTotal = total;

            if (isCouponApplied) {
                total = 0; // ‡¥ï‡µÇ‡¥™‡µç‡¥™‡µ∫ ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡¥æ‡µΩ ‡¥µ‡¥ø‡¥≤ ‡¥™‡µÇ‡¥ú‡µç‡¥Ø‡¥Æ‡¥æ‡¥ï‡µÅ‡¥Ç
                discountLine.style.display = 'block';
                discountAmount.textContent = originalTotal;
            } else {
                discountLine.style.display = 'none';
            }
            
            totalPriceElement.textContent = `‚Çπ${total}`;
            quantityDisplay.textContent = quantity;
        }

        function applyCoupon() {
            const couponCode = couponInput.value.trim().toUpperCase();
            
            if (couponCode === 'EVENTFREE') {
                isCouponApplied = true;
                couponAppliedInput.value = 'true';
                couponMessage.textContent = 'üéâ Coupon EVENTFREE applied successfully! Your booking is now FREE!';
                couponMessage.className = 'coupon-success';
                couponInput.style.borderColor = '#4CAF50';
                applyCouponBtn.textContent = 'Applied ‚úì';
                applyCouponBtn.disabled = true;
                applyCouponBtn.style.backgroundColor = '#4CAF50';
            } else if (couponCode === '') {
                couponMessage.textContent = 'Please enter a coupon code.';
                couponMessage.className = 'coupon-error';
                couponInput.style.borderColor = '#F44336';
            } else {
                isCouponApplied = false;
                couponAppliedInput.value = 'false';
                couponMessage.textContent = '‚ùå Invalid coupon code. Please try again.';
                couponMessage.className = 'coupon-error';
                couponInput.style.borderColor = '#F44336';
                applyCouponBtn.textContent = 'Apply Coupon';
                applyCouponBtn.disabled = false;
                applyCouponBtn.style.backgroundColor = '';
            }
            
            calculateTotal();
        }

        ticketQuantityInput.addEventListener('input', calculateTotal);

        applyCouponBtn.addEventListener('click', applyCoupon);

        couponInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyCoupon();
            }
        });

        // Initialize the page
        calculateTotal();
    </script>

</body>
</html>
