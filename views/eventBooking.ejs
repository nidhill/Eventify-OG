<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Tickets for <%= event.title %> | Eventify</title>
    <link rel="stylesheet" href="/home.css">
    <link rel="stylesheet" href="/event-booking.css">
    <style>
        .coupon-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border: 2px dashed #444;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.02);
        }

        .coupon-section h3 {
            margin-bottom: 1rem;
            color: #6366f1;
            font-size: 1.2rem;
        }

        .coupon-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .coupon-input-group input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 2px solid #444;
            background-color: #2c2c41;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .coupon-input-group input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .coupon-input-group button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            background-color: #6366f1;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .coupon-input-group button:hover:not(:disabled) {
            background-color: #4f46e5;
            transform: translateY(-1px);
        }

        .coupon-input-group button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #coupon-message {
            margin-top: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            padding: 0.5rem 0;
        }

        .coupon-success {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .coupon-error {
            color: #F44336;
            background-color: rgba(244, 67, 54, 0.1);
            padding: 0.75rem;
            border-radius: 8px;
            border-left: 4px solid #F44336;
        }

        .price-breakdown {
            margin-top: 1rem;
        }

        .price-breakdown p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            color: #ccc;
        }

        .price-breakdown .total-amount {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6366f1;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #444;
        }

        #discount-line {
            color: #4CAF50;
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .info-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item strong {
            display: block;
            color: #6366f1;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-item p {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }

        .event-description {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .event-description h3 {
            color: #6366f1;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .event-description p {
            color: #ccc;
            line-height: 1.6;
            margin: 0;
        }
    </style>
</head>
<body class="compact-page-body">

    <%- include('partials/header') %>

    <main class="event-booking-main">
        <div class="page-container">
            <!-- Left Column: Event Details -->
            <div class="event-details-column">
                <img class="event-banner-image" src="<%= event.image %>" alt="<%= event.title %> Banner">
                <div class="content-wrapper">
                    <span class="event-category"><%= event.category %></span>
                    <h1><%= event.title %></h1>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Date & Time</strong>
                            <% if (formattedDate !== 'Date not available') { %>
                                <p><%= formattedDate %> at <%= formattedTime %></p>
                            <% } else { %>
                                <p style="color: #ff6b6b;">Date to be announced</p>
                            <% } %>
                        </div>
                        <div class="info-item">
                            <strong>Location</strong>
                            <p><%= event.location %></p>
                        </div>
                        <div class="info-item">
                            <strong>Price</strong>
                            <p>
                                <% if (event.price == 0) { %>
                                    <span class="free-entry-text">Free Entry</span>
                                <% } else { %>
                                    ‚Çπ<%= event.price %>
                                <% } %>
                            </p>
                        </div>
                        <div class="info-item">
                            <strong>Category</strong>
                            <p><%= event.category %></p>
                        </div>
                    </div>
                    
                    <% if (event.description) { %>
                        <div class="event-description">
                            <h3>About This Event</h3>
                            <p><%= event.description %></p>
                        </div>
                    <% } %>
                    

                </div>
            </div>

            <!-- Right Column: Booking Form -->
            <div class="booking-form-column">
                <div class="booking-box">
                    <h3>Confirm Your Booking</h3>
                    <form class="booking-form" action="/booking/proceed-to-payment" method="POST">
                        <input type="hidden" name="eventId" value="<%= event._id %>">
                        <input type="hidden" name="couponApplied" id="coupon-applied" value="false">
                        
                        <div class="price-display">
                            <% if (event.price == 0) { %>
                                <span class="free-entry-text">Free Entry - No Payment Required</span>
                            <% } else { %>
                                Single Ticket Price: <strong>‚Çπ<span id="base-price"><%= event.price %></span></strong>
                            <% } %>
                        </div>

                        <div class="form-group">
                            <label for="customer-name">Full Name</label>
                            <input type="text" id="customer-name" name="customerName" value="<%= user && user.username ? user.username : '' %>" required>
                        </div>
                        <div class="form-group">
                            <label for="customer-phone">Phone Number</label>
                            <input type="tel" id="customer-phone" name="customerPhone" placeholder="10-digit phone number" required pattern="[0-9]{10}">
                        </div>
                        
                        <div class="form-group">
                            <label for="ticket-quantity">Number of Tickets</label>
                            <input type="number" id="ticket-quantity" name="quantity" value="1" min="1" max="10" required>
                        </div>
                        
                        <% if (event.price > 0) { %>
                        <!-- Coupon Section -->
                        <div class="coupon-section">
                            <h3>Have a Coupon Code?</h3>
                            <div class="coupon-input-group">
                                <input type="text" id="coupon-code" name="couponCode" placeholder="Enter coupon code (e.g., EVENTFREE)" maxlength="20">
                                <button type="button" id="apply-coupon-btn" class="btn btn-primary">Apply Coupon</button>
                            </div>
                            <p id="coupon-message"></p>
                        </div>
                        
                        <div class="price-details">
                            <div class="price-breakdown">
                                <p>Base Price: ‚Çπ<span id="base-price-display"><%= event.price %></span></p>
                                <p>Quantity: <span id="quantity-display">1</span></p>
                                <p id="discount-line" style="display: none;">Discount: -‚Çπ<span id="discount-amount">0</span></p>
                                <p class="total-amount">Total Amount: <span id="total-price">‚Çπ<%= event.price %></span></p>
                            </div>
                        </div>
                        <% } else { %>
                        <div class="free-event-notice">
                            <p class="free-entry-text">üéâ This is a free event! No payment required.</p>
                            <p>Just fill in your details and confirm your booking.</p>
                        </div>
                        <% } %>

                        <button type="submit" class="btn btn-primary btn-confirm-booking">
                            <% if (event.price == 0) { %>
                                Confirm Free Booking
                            <% } else { %>
                                Proceed to Pay
                            <% } %>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        const ticketQuantityInput = document.getElementById('ticket-quantity');
        const totalPriceElement = document.getElementById('total-price');
        const basePriceDisplay = document.getElementById('base-price-display');
        const quantityDisplay = document.getElementById('quantity-display');
        const discountLine = document.getElementById('discount-line');
        const discountAmount = document.getElementById('discount-amount');
        const basePrice = parseFloat(document.getElementById('base-price')?.textContent || '0');
        const couponInput = document.getElementById('coupon-code');
        const applyCouponBtn = document.getElementById('apply-coupon-btn');
        const couponMessage = document.getElementById('coupon-message');
        const couponAppliedInput = document.getElementById('coupon-applied');
        let isCouponApplied = false;
        let originalTotal = basePrice;
        const isFreeEvent = <%= event.price == 0 %>;

        function calculateTotal() {
            const quantity = parseInt(ticketQuantityInput.value, 10) || 0;
            
            if (isFreeEvent) {
                // Free event - no price calculation needed
                totalPriceElement.textContent = 'Free';
                quantityDisplay.textContent = quantity;
                return;
            }
            
            let total = basePrice * quantity;
            originalTotal = total;

            if (isCouponApplied) {
                total = 0; // ‡¥ï‡µÇ‡¥™‡µç‡¥™‡µ∫ ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡¥æ‡µΩ ‡¥µ‡¥ø‡¥≤ ‡¥™‡µÇ‡¥ú‡µç‡¥Ø‡¥Æ‡¥æ‡¥ï‡µÅ‡¥Ç
                discountLine.style.display = 'block';
                discountAmount.textContent = originalTotal;
            } else {
                discountLine.style.display = 'none';
            }
            
            totalPriceElement.textContent = `‚Çπ${total}`;
            quantityDisplay.textContent = quantity;
        }

        function applyCoupon() {
            if (isFreeEvent) {
                return; // No coupon needed for free events
            }
            
            const couponCode = couponInput.value.trim().toUpperCase();
            
            if (couponCode === 'EVENTFREE') {
                isCouponApplied = true;
                couponAppliedInput.value = 'true';
                couponMessage.textContent = 'üéâ Coupon EVENTFREE applied successfully! Your booking is now FREE!';
                couponMessage.className = 'coupon-success';
                couponInput.style.borderColor = '#4CAF50';
                applyCouponBtn.textContent = 'Applied ‚úì';
                applyCouponBtn.disabled = true;
                applyCouponBtn.style.backgroundColor = '#4CAF50';
            } else if (couponCode === '') {
                couponMessage.textContent = 'Please enter a coupon code.';
                couponMessage.className = 'coupon-error';
                couponInput.style.borderColor = '#F44336';
            } else {
                isCouponApplied = false;
                couponAppliedInput.value = 'false';
                couponMessage.textContent = '‚ùå Invalid coupon code. Please try again.';
                couponMessage.className = 'coupon-error';
                couponInput.style.borderColor = '#F44336';
                applyCouponBtn.textContent = 'Apply Coupon';
                applyCouponBtn.disabled = false;
                applyCouponBtn.style.backgroundColor = '';
            }
            
            calculateTotal();
        }

        // Only add event listeners if not a free event
        if (!isFreeEvent) {
            ticketQuantityInput.addEventListener('input', calculateTotal);
            applyCouponBtn.addEventListener('click', applyCoupon);
            couponInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyCoupon();
                }
            });
        }

        // Initialize the page
        calculateTotal();
    </script>

</body>
</html>
